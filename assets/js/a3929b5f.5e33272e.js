/*! For license information please see a3929b5f.5e33272e.js.LICENSE.txt */
"use strict";(self.webpackChunkreact_native_website=self.webpackChunkreact_native_website||[]).push([[67859],{26479:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var t=s(24246),r=s(71670);const a={id:"headless-js-android",title:"Headless JS\uff08\u540e\u53f0\u4efb\u52a1\uff09"},i=void 0,o={unversionedId:"headless-js-android",id:"version-0.71/headless-js-android",title:"Headless JS\uff08\u540e\u53f0\u4efb\u52a1\uff09",description:"Headless JS \u662f\u4e00\u79cd\u4f7f\u7528 js \u5728\u540e\u53f0\u6267\u884c\u4efb\u52a1\u7684\u65b9\u6cd5\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u5728\u540e\u53f0\u540c\u6b65\u6570\u636e\u3001\u5904\u7406\u63a8\u9001\u901a\u77e5\u6216\u662f\u64ad\u653e\u97f3\u4e50\u7b49\u7b49\u3002",source:"@site/versioned_docs/version-0.71/headless-js-android.md",sourceDirName:".",slug:"/headless-js-android",permalink:"/docs/0.71/headless-js-android",draft:!1,unlisted:!1,editUrl:"https://github.com/reactnativecn/react-native-website/blob/production/cnwebsite/../cndocs/headless-js-android.md",tags:[],version:"0.71",frontMatter:{id:"headless-js-android",title:"Headless JS\uff08\u540e\u53f0\u4efb\u52a1\uff09"},sidebar:"docs",previous:{title:"Appendix",permalink:"/docs/0.71/new-architecture-appendix"},next:{title:"\u6253\u5305\u53d1\u5e03",permalink:"/docs/0.71/signed-apk-android"}},c={},l=[{value:"JS \u7aef\u7684 API",id:"js-\u7aef\u7684-api",level:2},{value:"Java \u7aef\u7684 API",id:"java-\u7aef\u7684-api",level:2},{value:"\u91cd\u8bd5",id:"\u91cd\u8bd5",level:2},{value:"\u6ce8\u610f\u4e8b\u9879",id:"\u6ce8\u610f\u4e8b\u9879",level:2},{value:"\u793a\u4f8b",id:"\u793a\u4f8b",level:2}];function d(e){const n=Object.assign({p:"p",h2:"h2",code:"code",pre:"pre",strong:"strong",a:"a",ul:"ul",li:"li"},(0,r.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Headless JS \u662f\u4e00\u79cd\u4f7f\u7528 js \u5728\u540e\u53f0\u6267\u884c\u4efb\u52a1\u7684\u65b9\u6cd5\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u5728\u540e\u53f0\u540c\u6b65\u6570\u636e\u3001\u5904\u7406\u63a8\u9001\u901a\u77e5\u6216\u662f\u64ad\u653e\u97f3\u4e50\u7b49\u7b49\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"js-\u7aef\u7684-api",children:"JS \u7aef\u7684 API"}),"\n",(0,t.jsxs)(n.p,{children:["\u9996\u5148\u6211\u4eec\u8981\u901a\u8fc7",(0,t.jsx)(n.code,{children:"AppRegistry"}),"\u6765\u6ce8\u518c\u4e00\u4e2a\u5f02\u6b65\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u6211\u4eec\u79f0\u4e4b\u4e3a\u201c\u4efb\u52a1\u201d\u3002\u6ce8\u518c\u65b9\u5f0f\u7c7b\u4f3c\u5728 index.js \u4e2d\u6ce8\u518c RN \u5e94\u7528\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"import { AppRegistry } from 'react-native';\nAppRegistry.registerHeadlessTask('SomeTaskName', () =>\n  require('SomeTaskName')\n);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e\u521b\u5efa require \u4e2d\u5f15\u7528\u7684",(0,t.jsx)(n.code,{children:"SomeTaskName.js"}),"\u6587\u4ef6:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"module.exports = async taskData => {\n  // \u8981\u505a\u7684\u4efb\u52a1\n};\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4f60\u53ef\u4ee5\u5728\u4efb\u52a1\u4e2d\u5904\u7406\u4efb\u4f55\u4e8b\u60c5\uff08\u7f51\u7edc\u8bf7\u6c42\u3001\u5b9a\u65f6\u5668\u7b49\u7b49\uff09\uff0c\u4f46\u552f\u72ec",(0,t.jsx)(n.strong,{children:"\u4e0d\u8981\u6d89\u53ca\u7528\u6237\u754c\u9762"}),"\uff01\u5728\u4efb\u52a1\u5b8c\u6210\u540e\uff08\u4f8b\u5982\u5728 promise \u4e2d\u8c03\u7528 resolve\uff09\uff0cRN \u4f1a\u8fdb\u5165\u4e00\u4e2a\u201c\u6682\u505c\u201d\u6a21\u5f0f\uff0c\u76f4\u5230\u6709\u65b0\u4efb\u52a1\u9700\u8981\u6267\u884c\u6216\u8005\u662f\u5e94\u7528\u56de\u5230\u524d\u53f0\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"java-\u7aef\u7684-api",children:"Java \u7aef\u7684 API"}),"\n",(0,t.jsxs)(n.p,{children:["\u6ca1\u9519\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4e00\u4e9b\u539f\u751f\u4ee3\u7801\uff0c\u4f46\u662f\u8bf7\u653e\u5fc3\u5e76\u4e0d\u9ebb\u70e6\u3002\u9996\u5148\u9700\u8981\u50cf\u4e0b\u9762\u8fd9\u6837\u7ee7\u627f",(0,t.jsx)(n.code,{children:"HeadlessJsTaskService"}),"\uff0c\u7136\u540e\u8986\u76d6",(0,t.jsx)(n.code,{children:"getTaskConfig"}),"\u65b9\u6cd5\u7684\u5b9e\u73b0\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.your_application_name;\nimport android.content.Intent;\nimport android.os.Bundle;\nimport com.facebook.react.HeadlessJsTaskService;\nimport com.facebook.react.bridge.Arguments;\nimport com.facebook.react.jstasks.HeadlessJsTaskConfig;\nimport javax.annotation.Nullable;\n\npublic class MyTaskService extends HeadlessJsTaskService {\n\n  @Override\n  protected @Nullable HeadlessJsTaskConfig getTaskConfig(Intent intent) {\n    Bundle extras = intent.getExtras();\n    if (extras != null) {\n      return new HeadlessJsTaskConfig(\n          "SomeTaskName",\n          Arguments.fromBundle(extras),\n          5000, // \u4efb\u52a1\u7684\u8d85\u65f6\u65f6\u95f4\n          false // \u53ef\u9009\u53c2\u6570\uff1a\u662f\u5426\u5141\u8bb8\u4efb\u52a1\u5728\u524d\u53f0\u8fd0\u884c\uff0c\u9ed8\u8ba4\u4e3afalse\n        );\n    }\n    return null;\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e\u8bb0\u5f97\u628a\u670d\u52a1\u6dfb\u52a0\u5230",(0,t.jsx)(n.code,{children:"AndroidManifest"}),"\u6587\u4ef6\u91cc\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'<service android:name="com.example.MyTaskService" />\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u597d\u4e86\uff0c\u73b0\u5728\u5f53\u4f60",(0,t.jsx)(n.a,{href:"https://developer.android.com/reference/android/content/Context.html#startService(android.content.Intent)",children:"\u542f\u52a8\u670d\u52a1\u65f6"}),"\uff08\u4f8b\u5982\u4e00\u4e2a\u5468\u671f\u6027\u7684\u4efb\u52a1\u6216\u662f\u54cd\u5e94\u4e00\u4e9b\u7cfb\u7edf\u4e8b\u4ef6/\u5e7f\u64ad\uff09\uff0cJS \u4efb\u52a1\u5c31\u4f1a\u5f00\u59cb\u6267\u884c\u3002\u4f8b\u5982\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'Intent service = new Intent(getApplicationContext(), MyTaskService.class);\nBundle bundle = new Bundle();\n\nbundle.putString("foo", "bar");\nservice.putExtras(bundle);\n\ngetApplicationContext().startService(service);\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u91cd\u8bd5",children:"\u91cd\u8bd5"}),"\n",(0,t.jsxs)(n.p,{children:["By default, the headless JS task will not perform any retries. In order to do so, you need to create a ",(0,t.jsx)(n.code,{children:"HeadlessJsRetryPolicy"})," and throw a specfic ",(0,t.jsx)(n.code,{children:"Error"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"LinearCountingRetryPolicy"})," is an implementation of ",(0,t.jsx)(n.code,{children:"HeadlessJsRetryPolicy"})," that allows you to specify a maximum number of retries with a fixed delay between each attempt. If that does not suit your needs then you can easily implement your own ",(0,t.jsx)(n.code,{children:"HeadlessJsRetryPolicy"}),". These policies can simply be passed as an extra argument to the ",(0,t.jsx)(n.code,{children:"HeadlessJsTaskConfig"})," constructor, e.g."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"HeadlessJsRetryPolicy retryPolicy = new LinearCountingRetryPolicy(\n3, // Max number of retry attempts\n1000 // Delay between each retry attempt\n);\nreturn new HeadlessJsTaskConfig(\n'SomeTaskName',\nArguments.fromBundle(extras),\n5000,\nfalse,\nretryPolicy\n);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["A retry attempt will only be made when a specific ",(0,t.jsx)(n.code,{children:"Error"})," is thrown. Inside a headless JS task, you can import the error and throw it when a retry attempt is required."]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"import {HeadlessJsTaskError} from 'HeadlessJsTask';\nmodule.exports = async (taskData) => {\nconst condition = ...;\nif (!condition) {\n  throw new HeadlessJsTaskError();\n}\n};\n"})}),"\n",(0,t.jsx)(n.p,{children:"If you wish all errors to cause a retry attempt, you will need to catch them and throw the above error."}),"\n",(0,t.jsx)(n.h2,{id:"\u6ce8\u610f\u4e8b\u9879",children:"\u6ce8\u610f\u4e8b\u9879"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The function passed to ",(0,t.jsx)(n.code,{children:"setTimeout"})," does not always behave as expected. Instead the function is called only when the application is launched again. If you just need to wait, use the retry functionality."]}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u5e94\u7528\u6b63\u5728\u524d\u53f0\u8fd0\u884c\u65f6\u5c1d\u8bd5\u6267\u884c\u4efb\u52a1\uff0c\u90a3\u4e48\u5e94\u7528\u4f1a\u5d29\u6e83\u3002\u8fd9\u662f\u4e3a\u4e86\u9632\u6b62\u5f00\u53d1\u8005\u5728\u4efb\u52a1\u4e2d\u5904\u7406\u592a\u591a\u903b\u8f91\u800c\u62d6\u6162\u7528\u6237\u754c\u9762\u3002\u5982\u679c\u4f60\u5fc5\u987b\u8981\u8fd9\u4e48\u505a\uff0c\u90a3\u4e48\u53ef\u4ee5\u8bbe\u7f6e\u7b2c\u56db\u4e2a\u53c2\u6570\u4e3a",(0,t.jsx)(n.code,{children:"false"}),"\u6765\u66f4\u6539\u8fd9\u4e00\u9650\u5236\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:["\u5982\u679c\u4f60\u662f\u901a\u8fc7",(0,t.jsx)(n.code,{children:"BroadcastReceiver"}),"\u6765\u542f\u52a8\u7684\u670d\u52a1\uff0c\u90a3\u4e48\u8c28\u8bb0\u5728\u4ece",(0,t.jsx)(n.code,{children:"onReceive()"}),"\u8fd4\u56de\u4e4b\u524d\u8981\u8c03\u7528",(0,t.jsx)(n.code,{children:"HeadlessJsTaskService.acquireWakeLockNow()"}),"\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u793a\u4f8b",children:"\u793a\u4f8b"}),"\n",(0,t.jsx)(n.p,{children:"\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Java API \u6765\u5f00\u542f\u4e00\u4e2a service\u3002\u9996\u5148\u4f60\u9700\u8981\u8003\u8651\u597d Service \u542f\u52a8\u7684\u65f6\u673a\uff0c\u5e76\u636e\u6b64\u5b9e\u73b0\u76f8\u5173\u903b\u8f91\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4f7f\u7528 Service \u6765\u5904\u7406\u7f51\u7edc\u8fde\u63a5\u53d8\u5316\u7684\u7b80\u5355\u8303\u4f8b\u3002\n\u63a5\u4e0b\u6765\u7684\u51e0\u884c\u4ee3\u7801\u5c55\u793a\u4e86\u5982\u4f55\u5728 Android Manifest \u6587\u4ef6\u4e2d\u6ce8\u518c\u4e00\u4e2aBroadcast Receiver\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:'<receiver android:name=".NetworkChangeReceiver" >\n  <intent-filter>\n    <action android:name="android.net.conn.CONNECTIVITY_CHANGE" />\n  </intent-filter>\n</receiver>\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a Broadcast Receiver \u4e3b\u8981\u5728 onReceive \u51fd\u6570\u4e2d\u5904\u7406\u5e7f\u64ad Intent \u3002\u8fd9\u662f\u4e00\u4e2a\u8ba9\u4f60\u786e\u8ba4 App \u662f\u5426\u5728\u524d\u53f0\u5de5\u4f5c\u7684\u7edd\u4f73\u65f6\u673a\u3002\u5982\u679c App \u5f53\u524d\u4e0d\u5728\u524d\u53f0\u5de5\u4f5c\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u51c6\u5907\u6211\u4eec\u7528\u6765\u542f\u52a8 Service \u7684 Intent \u4e86\u3002\u989d\u5916\u63d0\u53ca\u4e00\u70b9\uff1a\u5982\u679c\u6709\u4fe1\u606f\u9700\u8981\u4f20\u9012\u7ed9Service\uff0c\u53ef\u4ee5\u4f7f\u7528 putExtra \u65b9\u6cd5\u628a\u4fe1\u606f\u6253\u5305\u6210 bundle\u643a\u5e26\u3002\u5f53\u7136\u4e5f\u53ef\u4ee5\u4e0d\u4f20\u9012\u4efb\u4f55\u4fe1\u606f\uff08\u4f46\u662f\uff0c\u59cb\u7ec8\u8c28\u8bb0 bundle \u53ea\u80fd\u591f\u627f\u8f7d\u90a3\u4e9b parcelable \u7684\u503c\uff09\u3002\u5728\u6700\u540e\uff0cService \u5c06\u83b7\u53d6\u5230 wakelock \u5e76\u542f\u52a8\u8d77\u6765\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public class NetworkChangeReceiver extends BroadcastReceiver {\n\n    @Override\n    public void onReceive(final Context context, final Intent intent) {\n        /**\n          \u8fd9\u90e8\u5206\u4ee3\u7801\u4f1a\u5728\u6bcf\u6b21\u7f51\u7edc\u72b6\u6001\u53d8\u5316\u65f6\u8c03\u7528\uff0c\u6bd4\u5982\u6389\u7ebf\u7684\u65f6\u5019\n        **/\n        if (!isAppOnForeground((context))) {\n            /**\n              \u542f\u52a8\u670d\u52a1\u5e76\u53d1\u9001\u5f53\u524d\u7684\u7f51\u7edc\u72b6\u6001\u4fe1\u606f\n            **/\n            boolean hasInternet = isNetworkAvailable(context);\n            Intent serviceIntent = new Intent(context, MyTaskService.class);\n            serviceIntent.putExtra("hasInternet", hasInternet);\n            context.startService(serviceIntent);\n            HeadlessJsTaskService.acquireWakeLockNow(context);\n        }\n    }\n\n    private boolean isAppOnForeground(Context context) {\n        /**\n          \u6211\u4eec\u9700\u8981\u5148\u68c0\u67e5\u5e94\u7528\u5f53\u524d\u662f\u5426\u5728\u524d\u53f0\u8fd0\u884c\uff0c\u5426\u5219\u5e94\u7528\u4f1a\u5d29\u6e83\u3002\n         http://stackoverflow.com/questions/8489993/check-android-application-is-in-foreground-or-not\n        **/\n        ActivityManager activityManager = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);\n        List<ActivityManager.RunningAppProcessInfo> appProcesses =\n        activityManager.getRunningAppProcesses();\n        if (appProcesses == null) {\n            return false;\n        }\n        final String packageName = context.getPackageName();\n        for (ActivityManager.RunningAppProcessInfo appProcess : appProcesses) {\n            if (appProcess.importance ==\n            ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND &&\n             appProcess.processName.equals(packageName)) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    public static boolean isNetworkAvailable(Context context) {\n        ConnectivityManager cm = (ConnectivityManager)\n        context.getSystemService(Context.CONNECTIVITY_SERVICE);\n        NetworkInfo netInfo = cm.getActiveNetworkInfo();\n        return (netInfo != null && netInfo.isConnected());\n    }\n\n\n}\n'})})]})}const p=function(e={}){const{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,t.jsx)(n,Object.assign({},e,{children:(0,t.jsx)(d,e)})):d(e)}},71426:(e,n,s)=>{var t=s(27378),r=Symbol.for("react.element"),a=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,o=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,n,s){var t,a={},l=null,d=null;for(t in void 0!==s&&(l=""+s),void 0!==n.key&&(l=""+n.key),void 0!==n.ref&&(d=n.ref),n)i.call(n,t)&&!c.hasOwnProperty(t)&&(a[t]=n[t]);if(e&&e.defaultProps)for(t in n=e.defaultProps)void 0===a[t]&&(a[t]=n[t]);return{$$typeof:r,type:e,key:l,ref:d,props:a,_owner:o.current}}n.Fragment=a,n.jsx=l,n.jsxs=l},24246:(e,n,s)=>{e.exports=s(71426)},71670:(e,n,s)=>{s.d(n,{Zo:()=>o,ah:()=>a});var t=s(27378);const r=t.createContext({});function a(e){const n=t.useContext(r);return t.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}const i={};function o({components:e,children:n,disableParentContext:s}){let o;return o=s?"function"==typeof e?e({}):e||i:a(e),t.createElement(r.Provider,{value:o},n)}}}]);